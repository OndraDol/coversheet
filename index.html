<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coversheet</title>
  <style>
    :root { --bg:#ffffff; --card:#ffffff; --muted:#5a718a; --text:#102a43; --accent:#005DA8; --border:#e5eef6; }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body { margin:0; font-family:system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial,"Apple Color Emoji","Segoe UI Emoji"; color:var(--text); background:#f7fbff; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    .container{ max-width:1100px; margin:0 auto; padding:32px 16px 80px; }
    header{ display:flex; align-items:center; justify-content:flex-start; gap:16px; margin-bottom:20px; border-top:6px solid var(--accent); padding-top:16px; }
    h1{ font-size:28px; margin:0; letter-spacing:.4px; color:var(--accent); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 8px 30px rgba(16,42,67,.08); }
    .form{ padding:20px; display:grid; grid-template-columns:repeat(12,1fr); gap:14px; }
    .field{ grid-column:span 12; display:flex; flex-direction:column; gap:6px; position:relative; }
    @media (min-width:720px){ .field.half{ grid-column:span 6; } .field.third{ grid-column:span 4; } .field.two{ grid-column:span 2; } }
    label{ font-size:12px; color:#0e2a47; font-weight:600; letter-spacing:.2px; }
    input[type="text"], input[type="date"], select, textarea{ width:100%; border:1px solid var(--border); background:#fff; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; transition:border-color .15s ease, box-shadow .15s ease; }
    textarea{ min-height:120px; resize:vertical; }
    input::placeholder{ color:#829ab1; }
    input:focus, select:focus, textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,93,168,.18); }
    .row{ display:flex; align-items:center; gap:14px; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:8px; background:#fff; border:1px solid var(--border); padding:8px 10px; border-radius:12px; color:var(--text); }
    .chip input{ transform:translateY(1px); }
    label.chip:has(input:checked){ background:#e8f3ff; border-color:var(--accent); color:var(--accent); }
    .muted{ color:var(--muted); font-size:12px; }
    .divider{ height:1px; background:var(--border); margin:8px 0 6px; grid-column:1 / -1; }
    .grid-compact{ display:grid; grid-template-columns:1fr 170px; gap:10px; }
    .grid-compact .subgrid{ display:grid; grid-template-columns:1fr 170px; gap:10px; grid-column:1 / -1; align-items:center; }
    .subgrid.varRow{ grid-template-columns:minmax(160px,1fr) 150px 20px 150px; }
    .sep{ text-align:center; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .actions.bottom{ justify-content:center; margin-top:16px; }
    button{ border:1px solid var(--accent); background:#fff; color:#005DA8; padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s ease all; }
    button.primary{ background:#005DA8; color:#fff; }
    button:hover{ filter:brightness(.98); box-shadow:0 4px 16px rgba(0,93,168,.18); }
    .linkbtn{ border:none; background:transparent; color:#005DA8; padding:4px 0; font-weight:700; cursor:pointer; }
    .linkbtn:hover{ text-decoration:underline; }
    @page{ size:A4; margin:16mm; }
    @media print{ 
      body{ background:#fff; } 
      header,.form,.actions{ display:none !important; } 
      #printView{ display:block !important; box-shadow:none; border:none; padding:12px; } 
      .printHeader{ margin-bottom:8px; } 
      .printHeader h2{ font-size:18px; } 
      .printTable{ font-size:12px; } 
      .printTable th,.printTable td{ padding:6px 6px; } 
      tr, td, th{ page-break-inside:avoid; } 
    }
    #printView{ display:none; padding:24px; border:1px solid var(--border); border-radius:12px; background:#fff; }
    .printHeader{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
    .printHeader h2{ color:#0b2b50; margin:0; font-size:22px; }
    .printMeta{ color:#333; font-size:12px; }
    .printTable{ width:100%; border-collapse:collapse; font-size:13px; }
    .printTable th,.printTable td{ border:1px solid #b7cbe0; padding:8px 10px; vertical-align:top; }
    .printTable th{ background:#eaf2fa; text-align:left; color:#0b2b50; }
    .printTable td{ white-space:pre-wrap; }
    .printTable td:first-child{ font-weight:700; color:#0b2b50; background:#f7fbff; }
    .printTable tr:nth-child(even) td{ background:#fbfdff; }
    .subhead{ font-weight:600; background:#f4f9ff; }
    .ta-wrap{ position:relative; }
    .ta-list{ position:absolute; z-index:40; top:100%; left:0; right:0; background:#fff; border:1px solid var(--border); border-radius:10px; margin-top:6px; max-height:200px; overflow:auto; box-shadow:0 8px 20px rgba(16,42,67,.12); padding:6px; display:none; }
    .ta-item{ padding:6px 8px; border-radius:8px; font-size:13px; cursor:pointer; }
    .ta-item:hover, .ta-item.active{ background:#e8f3ff; }
  </style>
</head>
<body>
  <div class="container">
    <header><h1>Coversheet</h1></header>

    <section class="card form" id="formRoot">
      <div class="field">
        <label for="fullName">Jméno a příjmení</label>
        <input id="fullName" type="text" placeholder="Jan Novák" />
      </div>

      <div class="field half">
        <label for="company">Společnost</label>
        <select id="company">
          <option value="AURES Holdings">AURES Holdings</option>
          <option>Resulmatic</option>
          <option>AURES ICT</option>
          <option>Mototechna Drive</option>
          <option>Mototechna Servis</option>
        </select>
      </div>

      <div class="field half">
        <label>Cizinec</label>
        <div class="row">
          <label class="chip"><input type="checkbox" id="foreignerYes"> Ano</label>
          <label class="chip"><input type="checkbox" id="foreignerNo" checked> Ne</label>
        </div>
      </div>

      <div class="field half">
        <label for="catRole">Katalogová pozice</label>
        <div class="ta-wrap">
          <input id="catRole" type="text" placeholder="Salesman" autocomplete="off" />
          <div id="taCat" class="ta-list"></div>
        </div>
      </div>

      <div class="field half">
        <label for="contractRole">Smluvní pozice</label>
        <div class="ta-wrap">
          <input id="contractRole" type="text" placeholder="Prodejce" autocomplete="off" />
          <div id="taContract" class="ta-list"></div>
        </div>
      </div>

      <div class="field half">
        <label for="branch">Pobočka</label>
        <select id="branch">
          <option value="">Vyberte pobočku</option>
          <option>Brno</option><option>České Budějovice</option><option>Chomutov</option>
          <option>Hradec Králové</option><option>Jihlava</option><option>Karviná</option>
          <option>Kladno</option><option>Kolín</option><option>Mladá Boleslav</option>
          <option>Liberec</option><option>Olomouc</option><option>Opava</option>
          <option>Ostrava</option><option>Otrokovice (Zlín)</option><option>Pardubice</option>
          <option>Plzeň</option><option>Praha - Čestlice</option><option>Praha - Klecany</option>
          <option selected>Praha 8 - Dolní Chabry</option>
          <option>Praha - Zličín</option>
          <option>Sokolov</option><option>Tábor</option><option>Teplice</option>
          <option>Ústí nad Labem</option><option>Valašské Meziříčí</option><option>Znojmo</option>
        </select>
      </div>

      <div class="field half">
        <label>Pracovní vztah</label>
        <div class="row">
          <label class="chip"><input type="radio" name="rel" id="relHPP" value="HPP" checked> HPP</label>
          <label class="chip"><input type="radio" name="rel" id="relDPP" value="DPP"> DPP</label>
          <label class="chip"><input type="radio" name="rel" id="relDPC" value="DPČ"> DPČ</label>
        </div>
      </div>

      <div class="field half">
        <label for="payFlag">Příznak proplacení</label>
        <select id="payFlag">
          <option selected>Ne</option>
          <option>jen So + Ne</option>
          <option>jen noční</option>
          <option>So + Ne + noční</option>
          <option>Svátky</option>
          <option>Svátky + So + Ne</option>
          <option>Svátky + noční</option>
          <option>Svátky + So + Ne + noční</option>
        </select>
      </div>

      <div class="field half">
        <label for="workTime">Pracovní doba</label>
        <select id="workTime">
          <option selected>Kr/dl týden 12 hod</option>
          <option>Po - Pá 8 hod</option>
        </select>
      </div>

      <div class="divider"></div>
      <div class="field half" id="hourlyWrap" style="display:none">
        <label for="hourly">Odměna (Kč / hod.)</label>
        <input id="hourly" type="text" placeholder="např. 180 Kč" />
      </div>

      <!-- HPP section without heading -->
      <div class="field" id="hppSection" style="display:block">
        <div class="grid-compact">
          <label>Základní mzda</label>
          <div class="subgrid">
            <input id="baseSalary" type="text" placeholder="částka v Kč" />
            <input id="baseFrom" type="date" title="Od" />
          </div>

          <label>KPI bonus</label>
          <div class="subgrid">
            <input id="kpiBonus" type="text" placeholder="0 - XXX Kč" value="0 - " />
            <input id="kpiFrom" type="date" title="Od" />
          </div>

          <label>OSOH</label>
          <div class="subgrid">
            <input id="osoh" type="text" placeholder="0 - XXX Kč" value="0 - " />
            <input id="osohFrom" type="date" title="Od" />
          </div>

          <label>Variabilní bonus</label>
          <div class="subgrid varRow">
            <input id="varBonus" type="text" placeholder="0 - XXX Kč" value="0 - " />
            <input id="varFrom" type="date" title="Od" />
            <span class="sep">–</span>
            <input id="varTo" type="date" title="Do" />
          </div>

          <div class="subgrid" style="grid-column:1 / -1">
            <button type="button" id="morePayBtn" class="linkbtn">+ Další mzdové složky</button>
          </div>
        </div>

        <div id="hppMore" class="grid-compact" style="display:none; margin-top:6px;">
          <label>Q bonus</label>
          <div class="subgrid">
            <input id="qBonus" type="text" placeholder="0 - XXX Kč" value="0 - " />
            <input id="qFrom" type="date" title="Od" />
          </div>
          <label>Roční bonus</label>
          <div class="subgrid">
            <input id="yearBonus" type="text" placeholder="0 - XXX Kč" value="0 - " />
            <input id="yearFrom" type="date" title="Od" />
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="field third">
        <label for="startDate">Datum nástupu</label>
        <input id="startDate" type="date" />
      </div>

      <div class="field third">
        <label for="signDate">Datum podpisu smlouvy</label>
        <input id="signDate" type="date" />
      </div>

      <div class="field third">
        <label for="signer">Podepisující</label>
        <input id="signer" type="text" placeholder="jméno podepisujícího" />
      </div>

      <div class="field third">
        <label for="signPrague">Podpis osobně v Praze</label>
        <select id="signPrague"><option selected>Ne</option><option>Ano</option></select>
      </div>

      <div class="field third">
        <label>Náborový příspěvek</label>
        <div class="row">
          <label class="chip"><input type="checkbox" id="recruitYes"> Ano</label>
          <label class="chip"><input type="checkbox" id="recruitNo" checked> Ne</label>
        </div>
        <div id="recruitWrap" class="row" style="margin-top:8px; display:none;">
          <label for="recruitAmt" class="muted">Výše příspěvku:</label>
          <select id="recruitAmt"><option value="30000">30 000 Kč</option><option value="50000">50 000 Kč</option></select>
        </div>
      </div>

      <div class="field third">
        <label>Home office</label>
        <div class="row">
          <label class="chip"><input type="checkbox" id="homeYes"> Ano</label>
          <label class="chip"><input type="checkbox" id="homeNo" checked> Ne</label>
        </div>
        <div id="homeWrap" class="row" style="margin-top:8px; display:none;">
          <label for="homeType" class="muted">Typ:</label>
          <select id="homeType">
            <option>Standard - zaměstnanec</option>
            <option>Standard - zaměstnavatel</option>
            <option>Dlouhodobá - zaměstnanec</option>
            <option>Dlouhodobá - zaměstnavatel</option>
          </select>
        </div>
        <div id="homePlaceWrap" style="margin-top:8px; display:none;">
          <label for="homePlace" class="muted">Místo výkonu práce</label>
          <input id="homePlace" type="text" placeholder="např. Praha" />
        </div>
      </div>

      <div class="field" style="grid-column:1 / -1;">
        <label for="notes">Poznámky</label>
        <textarea id="notes" placeholder="Jakékoliv další skutečnosti, které by měla personalistka vědět....
Doba určitá, zkrácený úvazek, zkušební doba...."></textarea>
      </div>
    </section>

    <div class="actions bottom">
      <button id="printBtn" class="primary">Uložit jako PDF</button>
      <button id="resetBtn" class="ghost">Vyčistit</button>
    </div>

    <section id="printView" class="card">
      <div class="printHeader">
        <h2 id="printTitle">Coversheet</h2>
        <div class="printMeta"><div>Vygenerováno: <span id="genAt"></span></div></div>
      </div>
      <table class="printTable">
        <tr><th style="width:32%">Pole</th><th>Hodnota</th></tr>
        <tr><td>Jméno a příjmení</td><td id="pv_fullName"></td></tr>
        <tr><td>Společnost</td><td id="pv_company"></td></tr>
        <tr><td>Cizinec</td><td id="pv_foreigner"></td></tr>
        <tr><td>Katalogová pozice</td><td id="pv_catRole"></td></tr>
        <tr><td>Smluvní pozice</td><td id="pv_contractRole"></td></tr>
        <tr><td>Pobočka</td><td id="pv_branch"></td></tr>
        <tr><td>Příznak proplacení</td><td id="pv_payFlag"></td></tr>
        <tr><td>Pracovní doba</td><td id="pv_workTime"></td></tr>
        <tr><td>Pracovní vztah</td><td id="pv_rel"></td></tr>
        <tr id="pv_dpp_head" class="subhead"><td colspan="2">DPP / DPČ</td></tr>
        <tr id="pv_hourly_row" style="display:none"><td>Odměna</td><td id="pv_hourly"></td></tr>
        <tr id="pv_hpp_base" style="display:none"><td>Základní mzda</td><td id="pv_base"></td></tr>
        <tr id="pv_hpp_kpi" style="display:none"><td>KPI bonus</td><td id="pv_kpi"></td></tr>
        <tr id="pv_hpp_osoh" style="display:none"><td>OSOH</td><td id="pv_osoh"></td></tr>
        <tr id="pv_hpp_var" style="display:none"><td>Variabilní bonus</td><td id="pv_var"></td></tr>
        <tr id="pv_hpp_q" style="display:none"><td>Q bonus</td><td id="pv_q"></td></tr>
        <tr id="pv_hpp_year" style="display:none"><td>Roční bonus</td><td id="pv_year"></td></tr>
        <tr><td>Datum nástupu</td><td id="pv_start"></td></tr>
        <tr><td>Datum podpisu smlouvy</td><td id="pv_signDate"></td></tr>
        <tr><td>Podepisující</td><td id="pv_signer"></td></tr>
        <tr><td>Podpis osobně v Praze</td><td id="pv_signPrague"></td></tr>
        <tr><td>Náborový příspěvek</td><td id="pv_recruit"></td></tr>
        <tr><td>Home office</td><td id="pv_home"></td></tr>
        <tr id="pv_homePlace_row" style="display:none"><td>Místo výkonu práce</td><td id="pv_homePlace"></td></tr>
        <tr><td>Poznámky</td><td id="pv_notes"></td></tr>
      </table>
    </section>
  </div>

  <script id="position-data" type="application/json">[{"catalog":"Salesman","contract":"Prodejce"}]</script>
  <script>
    const $ = (s) => document.querySelector(s);

    function fmtCZK(v){ const s = String(v); let digits = ''; for (let i=0;i<s.length;i++){ const c=s.charCodeAt(i); if (c>=48 && c<=57) digits += s[i]; } if (!digits) return ''; const n = parseInt(digits,10); if (!isFinite(n)) return ''; return new Intl.NumberFormat('cs-CZ',{style:'currency',currency:'CZK',maximumFractionDigits:0}).format(n); }
    function fmtDate(v){ if(!v) return ''; const d=new Date(v); if(String(d)==='Invalid Date') return ''; return d.toLocaleDateString('cs-CZ'); }
    function fmtRange(f,t){ const a=fmtDate(f), b=fmtDate(t); if(!a && !b) return ''; return (a||'') + ' - ' + (b||''); }
    function hasDigit(t){ for(let i=0;i<t.length;i++){ const c=t.charCodeAt(i); if(c>=48 && c<=57) return true; } return false; }
    function formatNumbersWithSpaces(text){ const s=String(text); let out='', i=0; while(i<s.length){ const ch=s.charCodeAt(i); if(ch>=48 && ch<=57){ let j=i; while(j<s.length){ const c=s.charCodeAt(j); if(c<48||c>57) break; j++; } const num=s.slice(i,j); let rev='',cnt=0; for(let k=num.length-1;k>=0;k--){ rev+=num[k]; cnt++; if(cnt%3===0 && k!==0) rev+=' '; } out+=rev.split('').reverse().join(''); i=j; } else { out+=s[i]; i++; } } return out; }
    function ensureKcSuffix(text){
      let t=String(text||'').trim();
      t = t.replace(/\s*Kč\s*$/i,''); // dedupe "Kč"
      if(!hasDigit(t)) return t;
      return t+' Kč';
    }

    const els = { 
      fullName: $('#fullName'), company: $('#company'),
      foreignerYes: $('#foreignerYes'), foreignerNo: $('#foreignerNo'),
      catRole: $('#catRole'), contractRole: $('#contractRole'), branch: $('#branch'),
      payFlag: $('#payFlag'), workTime: $('#workTime'),
      relHPP: $('#relHPP'), relDPP: $('#relDPP'), relDPC: $('#relDPC'),
      hourlyWrap: $('#hourlyWrap'), hourly: $('#hourly'),
      hppSection: $('#hppSection'),
      baseSalary: $('#baseSalary'), baseFrom: $('#baseFrom'),
      kpiBonus: $('#kpiBonus'), kpiFrom: $('#kpiFrom'),
      osoh: $('#osoh'), osohFrom: $('#osohFrom'),
      varBonus: $('#varBonus'), varFrom: $('#varFrom'), varTo: $('#varTo'),
      qBonus: $('#qBonus'), qFrom: $('#qFrom'),
      yearBonus: $('#yearBonus'), yearFrom: $('#yearFrom'),
      moreBtn: $('#morePayBtn'), hppMore: $('#hppMore'),
      startDate: $('#startDate'), signDate: $('#signDate'), signer: $('#signer'),
      signPrague: $('#signPrague'),
      recruitYes: $('#recruitYes'), recruitNo: $('#recruitNo'), recruitWrap: $('#recruitWrap'), recruitAmt: $('#recruitAmt'),
      homeYes: $('#homeYes'), homeNo: $('#homeNo'), homeWrap: $('#homeWrap'), homeType: $('#homeType'),
      homePlaceWrap: $('#homePlaceWrap'), homePlace: $('#homePlace'),
      notes: $('#notes'),
      printBtn: $('#printBtn'), resetBtn: $('#resetBtn'),
      pv: { genAt: $('#genAt'), printTitle: $('#printTitle'), fullName: $('#pv_fullName'), company: $('#pv_company'), foreigner: $('#pv_foreigner'), catRole: $('#pv_catRole'), contractRole: $('#pv_contractRole'), branch: $('#pv_branch'), payFlag: $('#pv_payFlag'), workTime: $('#pv_workTime'), rel: $('#pv_rel'), dppHead: $('#pv_dpp_head'), hourlyRow: $('#pv_hourly_row'), hourly: $('#pv_hourly'), hpp: { baseRow: $('#pv_hpp_base'), base: $('#pv_base'), kpiRow: $('#pv_hpp_kpi'), kpi: $('#pv_kpi'), osohRow: $('#pv_hpp_osoh'), osoh: $('#pv_osoh'), varRow: $('#pv_hpp_var'), v: $('#pv_var'), qRow: $('#pv_hpp_q'), q: $('#pv_q'), yearRow: $('#pv_hpp_year'), year: $('#pv_year') }, start: $('#pv_start'), signDate: $('#pv_signDate'), signer: $('#pv_signer'), signPrague: $('#pv_signPrague'), recruit: $('#pv_recruit'), home: $('#pv_home'), homePlaceRow: $('#pv_homePlace_row'), homePlace: $('#pv_homePlace'), notes: $('#pv_notes') }
    };

    // defaults
    els.company.value='AURES Holdings';
    els.branch.value='Praha 8 - Dolní Chabry';

    function makeExclusive(a,b){ a.addEventListener('change',()=>{ if(a.checked) b.checked=false; if(!a.checked && !b.checked) b.checked=true; updateUI(); }); b.addEventListener('change',()=>{ if(b.checked) a.checked=false; if(!a.checked && !b.checked) a.checked=true; updateUI(); }); }
    makeExclusive(els.foreignerYes, els.foreignerNo);
    makeExclusive(els.recruitYes, els.recruitNo);
    makeExclusive(els.homeYes, els.homeNo);

    ['baseSalary','kpiBonus','osoh','varBonus','qBonus','yearBonus','hourly'].forEach(id=>{ const el=els[id]; el.addEventListener('blur',()=>{ let v=el.value; v=formatNumbersWithSpaces(v); v=ensureKcSuffix(v); el.value=v; updatePreview(); }); });

    [els.relHPP, els.relDPP, els.relDPC].forEach(r => r.addEventListener('change', updateUI));

    els.recruitYes.addEventListener('change', ()=>{ els.recruitWrap.style.display = els.recruitYes.checked ? 'flex' : 'none'; updateUI(); });
    els.recruitNo .addEventListener('change', ()=>{ els.recruitWrap.style.display = els.recruitYes.checked ? 'flex' : 'none'; updateUI(); });
    els.homeYes   .addEventListener('change', ()=>{ const on=els.homeYes.checked; els.homeWrap.style.display = on ? 'flex' : 'none'; els.homePlaceWrap.style.display = on ? 'block' : 'none'; updateUI(); });
    els.homeNo    .addEventListener('change', ()=>{ const on=els.homeYes.checked; els.homeWrap.style.display = on ? 'flex' : 'none'; els.homePlaceWrap.style.display = on ? 'block' : 'none'; updateUI(); });

    // More pay items toggle
    els.moreBtn?.addEventListener('click', ()=>{ 
      const open = els.hppMore.style.display !== 'none'; 
      els.hppMore.style.display = open ? 'none' : 'block'; 
      els.moreBtn.textContent = open ? '+ Další mzdové složky' : '− Skrýt mzdové složky'; 
    });

    // Typeahead (compact)
    const POSITIONS = JSON.parse(document.getElementById('position-data').textContent||'[]');
    const catList = document.getElementById('taCat');
    const conList = document.getElementById('taContract');

    function uniqueContracts(list){ const set=new Set(); const out=[]; list.forEach(p=>{ const v=(p.contract||'').trim(); if(v && !set.has(v)){ set.add(v); out.push(v); } }); return out; }
    const CONTRACTS = uniqueContracts(POSITIONS);

    function norm(s){ return String(s||'').toLowerCase(); }
    function buildList(container, items, onPick){
      container.innerHTML = items.map((txt,i)=>`<div class="ta-item" data-idx="${i}"></div>`).join('');
      Array.from(container.children).forEach((el,i)=>{ el.textContent = items[i]; el.addEventListener('mousedown', (e)=>{ e.preventDefault(); onPick(items[i]); hide(container); }); });
      show(container);
    }
    function show(el){ el.style.display='block'; }
    function hide(el){ el.style.display='none'; el.innerHTML=''; }
    function attachTypeahead(input, container, sourceItems, onPick){ 
      let cursor=-1;
      function refresh(){ 
        const q = norm(input.value).trim();
        if (!q) { hide(container); return; }
        const opts = sourceItems.filter(v=>norm(v).startsWith(q)).slice(0, 20);
        if (!opts.length) { hide(container); return; }
        buildList(container, opts, onPick);
        cursor=-1;
      }
      input.addEventListener('input', refresh);
      input.addEventListener('focus', refresh);
      input.addEventListener('keydown', (e)=>{ 
        const open = container.style.display==='block';
        if (!open) return;
        const items = Array.from(container.querySelectorAll('.ta-item'));
        if (e.key==='ArrowDown'){ e.preventDefault(); cursor = Math.min(items.length-1, cursor+1); items.forEach(i=>i.classList.remove('active')); if (cursor>=0) items[cursor].classList.add('active'); }
        else if (e.key==='ArrowUp'){ e.preventDefault(); cursor = Math.max(0, cursor-1); items.forEach(i=>i.classList.remove('active')); if (cursor>=0) items[cursor].classList.add('active'); }
        else if (e.key==='Enter'){ if (cursor>=0){ e.preventDefault(); const val = items[cursor].textContent; onPick(val); hide(container); } }
        else if (e.key==='Escape'){ hide(container); }
      });
      input.addEventListener('blur', ()=>{ setTimeout(()=>hide(container), 120); });
    }

    attachTypeahead(els.catRole, catList, POSITIONS.map(p=>p.catalog), (picked)=>{ 
      els.catRole.value = picked; 
      const m = POSITIONS.find(p=>norm(p.catalog)===norm(picked));
      if (m && m.contract) els.contractRole.value = m.contract;
      updatePreview();
    });

    attachTypeahead(els.contractRole, conList, CONTRACTS, (picked)=>{ 
      els.contractRole.value = picked; 
      if (!els.catRole.value){ const m = POSITIONS.find(p=>norm(p.contract)===norm(picked)); if (m) els.catRole.value = m.catalog; }
      updatePreview();
    });

    // --- Filename helpers (fixed diacritics removal) ---
    function stripDiacritics(s){
      return String(s||'').normalize('NFD').replace(/\p{M}+/gu, '');
    }
    function tokenize(s){
      const t = stripDiacritics(s).replace(/[^A-Za-z0-9]+/g,'-').replace(/^-+|-+$/g,'').replace(/-{2,}/g,'-');
      return t;
    }
    function buildPdfFilename(){
      const full = (els.fullName.value||'').trim();
      const surname = full ? full.split(/\s+/).slice(-1)[0] : '';
      const cat = els.catRole.value||'';
      const branch = els.branch.value||'';
      const d = els.startDate.value ? new Date(els.startDate.value) : null;
      const m = d ? (d.getMonth()+1).toString() : '';
      const y = d ? d.getFullYear().toString() : '';
      const parts = ['Coversheet', tokenize(surname), tokenize(cat), tokenize(branch), m, y].filter(Boolean);
      return parts.join('_') || 'Coversheet';
    }

    // Buttons
    els.printBtn.addEventListener('click',(e)=>{ 
      e.preventDefault(); 
      updatePreview(); 
      const prev = document.title;
      document.title = buildPdfFilename();
      const restore = ()=>{ document.title = prev; window.removeEventListener('afterprint', restore); };
      window.addEventListener('afterprint', restore);
      setTimeout(()=>window.print(),20); 
    });
    els.resetBtn.addEventListener('click',(e)=>{ 
      e.preventDefault();
      document.getElementById('formRoot').querySelectorAll('input').forEach(inp=>{ if(inp.type==='checkbox'||inp.type==='radio') return; inp.value=''; });
      els.company.value='AURES Holdings';
      els.branch.value='Praha 8 - Dolní Chabry';
      els.signPrague.value='Ne';
      els.payFlag.value='Ne';
      els.workTime.value='Kr/dl týden 12 hod';
      els.relHPP.checked=true; els.relDPP.checked=false; els.relDPC.checked=false;
      els.hourlyWrap.style.display='none';
      els.hppSection.style.display='block';
      els.hppMore.style.display='none'; els.moreBtn && (els.moreBtn.textContent='+ Další mzdové složky');
      els.recruitNo.checked=true; els.recruitYes.checked=false; els.recruitWrap.style.display='none';
      els.homeNo.checked=true; els.homeYes.checked=false; els.homeWrap.style.display='none'; els.homePlaceWrap.style.display='none'; els.homePlace.value='';
      els.foreignerNo.checked=true; els.foreignerYes.checked=false;
      els.kpiBonus.value='0 - '; els.osoh.value='0 - '; els.varBonus.value='0 - '; els.qBonus && (els.qBonus.value='0 - '); els.yearBonus && (els.yearBonus.value='0 - ');
      els.notes.value='';
      updateUI(); updatePreview();
    });

    function cleanBonusAmount(val){ const t=String(val||'').trim(); return /^0\s*-\s*(Kč)?$/i.test(t) ? '' : t; }
    function amountWithFrom(val, fromDate){ const amt=(val||'').toString().trim(); const when=fmtDate(fromDate); if(!amt && !when) return ''; if(amt && when) return `${amt} (od ${when})`; return amt || `od ${when}`; }
    function amountWithRange(val, fromDate, toDate){ 
      const amt=(val||'').toString().trim(); 
      const range = fmtRange(fromDate, toDate); 
      if(!amt && !range) return ''; 
      if(amt && range) return `${amt} (${range})`; 
      return amt || range; 
    }

    function updateUI(){ 
      const rel = document.querySelector('input[name="rel"]:checked')?.value || 'HPP';
      const showHourly = rel === 'DPP' || rel === 'DPČ';
      els.hourlyWrap.style.display = showHourly ? 'block' : 'none';
      els.hppSection.style.display = (rel === 'HPP') ? 'block' : 'none';
      updatePreview();
    }

    function updatePreview(){ 
      els.pv.genAt.textContent=new Date().toLocaleString('cs-CZ');
      const nameTitle = els.fullName.value.trim();
      els.pv.printTitle.textContent = nameTitle ? `Coversheet - ${nameTitle}` : 'Coversheet';

      els.pv.fullName.textContent=els.fullName.value.trim();
      els.pv.company.textContent=els.company.value;
      els.pv.foreigner.textContent=els.foreignerYes.checked ? 'Ano' : 'Ne';
      els.pv.catRole.textContent=els.catRole.value.trim();
      els.pv.contractRole.textContent=els.contractRole.value.trim();
      els.pv.branch.textContent=els.branch.value || '';
      els.pv.payFlag.textContent=els.payFlag.value || 'Ne';
      els.pv.workTime.textContent=els.workTime.value || '';
      const rel = document.querySelector('input[name="rel"]:checked')?.value || 'HPP';
      els.pv.rel.textContent=rel;

      const showHourly = rel === 'DPP' || rel === 'DPČ';
      els.pv.hourlyRow.style.display=showHourly ? '' : 'none';
      els.pv.hourly.textContent=els.hourly.value ? `${fmtCZK(els.hourly.value)}/hod.` : '';
      els.pv.dppHead.style.display = (showHourly && !!els.pv.hourly.textContent) ? '' : 'none';

      const hpp = rel === 'HPP';
      const base = amountWithFrom(els.baseSalary.value, els.baseFrom.value);
      const kpi  = amountWithFrom(cleanBonusAmount(els.kpiBonus.value), els.kpiFrom.value);
      const osoh = amountWithFrom(cleanBonusAmount(els.osoh.value), els.osohFrom.value);
      const v    = amountWithRange(cleanBonusAmount(els.varBonus.value), els.varFrom.value, els.varTo.value);
      const q    = amountWithFrom(cleanBonusAmount(els.qBonus?.value||''), els.qFrom?.value||'');
      const year = amountWithFrom(cleanBonusAmount(els.yearBonus?.value||''), els.yearFrom?.value||'');

      els.pv.hpp.baseRow.style.display = hpp && base ? '' : 'none';
      els.pv.hpp.kpiRow.style.display  = hpp && kpi  ? '' : 'none';
      els.pv.hpp.osohRow.style.display = hpp && osoh ? '' : 'none';
      els.pv.hpp.varRow.style.display  = hpp && v    ? '' : 'none';
      els.pv.hpp.qRow.style.display    = hpp && q    ? '' : 'none';
      els.pv.hpp.yearRow.style.display = hpp && year ? '' : 'none';

      els.pv.hpp.base.textContent=base;
      els.pv.hpp.kpi.textContent=kpi;
      els.pv.hpp.osoh.textContent=osoh;
      els.pv.hpp.v.textContent=v;
      els.pv.hpp.q.textContent=q;
      els.pv.hpp.year.textContent=year;

      els.pv.start.textContent=fmtDate(els.startDate.value);
      els.pv.signDate.textContent=fmtDate(els.signDate.value);
      els.pv.signer.textContent=els.signer.value.trim();
      els.pv.signPrague.textContent=els.signPrague.value;

      if(els.homeYes.checked){
        els.pv.home.textContent=`Ano – ${els.homeType.value}`;
        const place=els.homePlace.value.trim();
        els.pv.homePlace.textContent=place;
        els.pv.homePlaceRow.style.display=place ? '' : 'none';
      } else {
        els.pv.home.textContent='Ne';
        els.pv.homePlace.textContent='';
        els.pv.homePlaceRow.style.display='none';
      }

      els.pv.recruit.textContent=els.recruitYes.checked ? `Ano – ${els.recruitAmt.value==='50000' ? '50 000 Kč' : '30 000 Kč'}` : 'Ne';
      els.pv.notes.textContent=els.notes.value.trim();
    }

    // init
    updateUI(); updatePreview();
  </script>
</body>
</html>
